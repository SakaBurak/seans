{% extends 'base.html' %}

{% block page_title %}Seans Düzenle{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Seans Düzenle</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="client_name" class="form-label">Danışan Adı *</label>
                            <input type="text" class="form-control" id="client_name" name="client_name" value="{{ session.client_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="expert" class="form-label">Psikolog *</label>
                            <select class="form-select" id="expert" name="expert" required>
                                <option value="">Seçiniz</option>
                                {% for psychologist in psychologists %}
                                    <option value="{{ psychologist.id }}" {% if psychologist.id == session.expert.id %}selected{% endif %}>
                                        {{ psychologist.user.get_full_name|default:psychologist.user.username }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Tarih ve Saat *</label>
                            <input type="datetime-local" class="form-control" id="date" name="date" value="{{ session.date|date:'Y-m-d\TH:i' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="duration" class="form-label">Süre (Dakika) *</label>
                            <input type="number" class="form-control" id="duration" name="duration" min="15" max="300" value="{{ session.duration }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Ücret (₺) *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" value="{{ session_price_str }}" required readonly>
                                <button type="button" class="btn btn-outline-warning" onclick="enablePriceEdit()">
                                    <i class="fas fa-edit"></i> Değiştir
                                </button>
                            </div>
                            <small class="form-text text-muted">Ücret değiştirmek için "Değiştir" butonuna tıklayın</small>

                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="extra_commission_rate" class="form-label">Ek Kesinti Oranı (%)</label>
                            <input type="number" class="form-control" id="extra_commission_rate" name="extra_commission_rate" min="0" max="100" step="0.01" value="{{ session.extra_commission_rate }}" placeholder="0.00">
                            <small class="form-text text-muted">Bu seans için özel ek kesinti oranı</small>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Durum *</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="planned" {% if session.status == 'planned' %}selected{% endif %}>Planlandı</option>
                                <option value="done" {% if session.status == 'done' %}selected{% endif %}>Yapıldı</option>
                                <option value="canceled" {% if session.status == 'canceled' %}selected{% endif %}>İptal</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="session_type" class="form-label">Seans Türü *</label>
                            <select class="form-select" id="session_type" name="session_type" required>
                                <option value="online" {% if session.session_type == 'online' %}selected{% endif %}>Online</option>
                                <option value="face_to_face" {% if session.session_type == 'face_to_face' %}selected{% endif %}>Yüz Yüze</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="payment_method" class="form-label">Ödeme Yöntemi *</label>
                            <select class="form-select" id="payment_method" name="payment_method" required>
                                <option value="cash" {% if session.payment_method == 'cash' %}selected{% endif %}>Nakit</option>
                                <option value="credit_card" {% if session.payment_method == 'credit_card' %}selected{% endif %}>Kredi Kartı</option>
                                <option value="debit_card" {% if session.payment_method == 'debit_card' %}selected{% endif %}>Banka Kartı</option>
                                <option value="bank_transfer" {% if session.payment_method == 'bank_transfer' %}selected{% endif %}>Havale</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notlar</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Seans hakkında notlar...">{{ session.notes|default:'' }}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'manage_sessions' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Geri Dön
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Değişiklikleri Kaydet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function enablePriceEdit() {
    const priceInput = document.getElementById('price');
    const currentPrice = priceInput.value;
    
    if (confirm(`Mevcut ücret: ₺${currentPrice}\n\nÜcret değiştirmek istediğinizden emin misiniz?`)) {
        priceInput.readOnly = false;
        priceInput.focus();
        priceInput.style.backgroundColor = '#fff3cd';
        
        // Değiştir butonunu devre dışı bırak
        const editButton = priceInput.parentElement.querySelector('button');
        editButton.disabled = true;
        editButton.innerHTML = '<i class="fas fa-check"></i> Aktif';
        editButton.className = 'btn btn-outline-success';
    }
}

// Form gönderilmeden önce ücret kontrolü
document.querySelector('form').addEventListener('submit', function(e) {
    const priceInput = document.getElementById('price');
    const price = parseFloat(priceInput.value);
    
    if (isNaN(price) || price < 0) {
        e.preventDefault();
        alert('Lütfen geçerli bir ücret girin!');
        priceInput.focus();
        return false;
    }
    
    if (price === 0) {
        if (!confirm('Ücret 0 olarak ayarlanmış. Bu doğru mu?')) {
            e.preventDefault();
            priceInput.focus();
            return false;
        }
    }
});
</script>
{% endblock %} 